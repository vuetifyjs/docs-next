<template>
  <app-ad
    :color="bgColor"
    v-bind="$props"
  >
    <v-list-item
      v-if="current"
      :color="bgColor"
      class="px-2 rounded"
      style="min-height: inherit;"
      v-bind="adAttrs"
    >
      <v-list-item-avatar
        v-if="metadata.src && !compact"
        size="56"
        tile
      >
        <v-img
          :alt="`Link to ${current.title}`"
          :src="metadata.src"
          class="rounded-tl rounded-bl"
        />
      </v-list-item-avatar>

      <v-icon
        v-else-if="icon"
        :class="[color]"
        class="mr-3"
        large
        v-text="icon"
      />

      <v-list-item-content class="py-2">
        <v-list-item-title
          v-if="!isSponsored"
          class="font-weight-medium mb-1 subtitle-1"
          v-text="current.title"
        />

        <div
          v-if="metadata.description"
          :class="{
            [color || 'text--secondary']: true,
            'body-1 font-weight-medium': isSponsored,
            'caption': !isSponsored
          }"
          v-text="metadata.description"
        />
      </v-list-item-content>

      <i18n
        v-if="!compact"
        class="powered-by align-self-end my-2"
        path="ads-via-vuetify"
        tag="div"
      />
    </v-list-item>
  </app-ad>
</template>

<script>
  // Utilities
  import { get } from 'vuex-pathify'

  export default {
    name: 'VuetifyAd',

    props: {
      bgColor: String,
      color: String,
      comfortable: Boolean,
      compact: Boolean,
      discover: Boolean,
      outlined: Boolean,
      slug: String,
    },

    computed: {
      all: get('ads/all'),
      locale: get('route/params@locale'),
      ads () {
        if (!this.discover) return this.all

        return this.all.filter(ad => ad.metadata.type === 'Discovery')
      },
      adAttrs () {
        if (!this.current) return undefined

        const [url, query] = this.metadata.url.split('?')

        if (!url.startsWith('http')) {
          return { to: `/${this.locale}${url}/` }
        }

        return {
          href: `${url}?ref=vuetifyjs.com${query ? `&${query}` : ''}`,
          target: '_blank',
        }
      },
      icon () {
        switch (this.metadata.type) {
          case 'Video': return '$mdiPlayCircle'
          default: return '$mdiVuetify'
        }
      },
      isSponsored () {
        return this.metadata.sponsored
      },
      current () {
        const index = !this.slug
          ? this.getRandomIndex()
          : this.getSlugIndex()

        return this.ads[index]
      },
      metadata () {
        return this.current ? this.current.metadata : {}
      },
    },

    methods: {
      getSlugIndex () {
        return this.ads.findIndex(ad => ad.slug === this.slug)
      },
      getRandomIndex () {
        return Math.floor(Math.random() * this.ads.length)
      },
    },
  }
</script>

<style lang="sass">
  .powered-by
    color: rgba(0, 0, 0, .6)
    font-size: 0.625rem
    font-weight: 400
    letter-spacing: 0.09375rem
    text-transform: uppercase
</style>
